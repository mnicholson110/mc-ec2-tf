name: minecraft-base
schemaVersion: 1.0
phases:
  - name: build
    steps:
      - name: install_packages
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -euxo pipefail
              dnf -y update
              dnf -y install java-21-amazon-corretto-headless jq logrotate
      - name: create_user_dirs
        action: ExecuteBash
        inputs:
          commands:
            - |
              id -u minecraft 2>/dev/null || useradd --system --home /opt/minecraft --shell /sbin/nologin minecraft
              mkdir -p /opt/minecraft/{logs,bin}
              chown -R minecraft:minecraft /opt/minecraft
      - name: create_config_dir
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -euxo pipefail
              # Ensure config dir exists so systemd ReadWritePaths for /etc/minecraft doesn't fail
              mkdir -p /etc/minecraft
      - name: prepare_mc_app
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -euxo pipefail
              mkdir -p /opt/mc-app
              chown root:root /opt/mc-app
              chmod 0755 /opt/mc-app
      - name: download_paper_jar
        action: ExecuteBash
        inputs:
          commands:
            - |
              set -euxo pipefail
              UA="mc-ec2-imagebuilder/1.0 ([emailÂ protected])"
              MC_VERSION="1.21.8"
              # Resolve latest stable build for the pinned version
              URL=$(curl -fsSL -H "User-Agent: $UA" "https://fill.papermc.io/v3/projects/paper/versions/${MC_VERSION}/builds" \
                    | jq -r 'first(.[] | select(.channel=="STABLE") | .downloads."server:default".url) // empty')
              if [[ -z "$URL" ]]; then
                echo "Failed to resolve Paper URL for ${MC_VERSION}" >&2
                exit 1
              fi
              curl -fSL -H "User-Agent: $UA" -o /opt/mc-app/server.jar "$URL"
              chmod 0644 /opt/mc-app/server.jar
      - name: write_launch_script
        action: CreateFile
        inputs:
          - path: /opt/mc-app/launch.sh
            permissions: '0755'
            owner: root
            group: root
            content: |
              #!/usr/bin/env bash
              set -euo pipefail
              APP_DIR=/opt/mc-app
              MC_DIR=/opt/minecraft
              # Load runtime overrides (version, heap, flags)
              if [ -f /etc/minecraft/minecraft.env ]; then
                set -a; . /etc/minecraft/minecraft.env; set +a
              fi
              : "${MC_VERSION:=1.21.8}"
              : "${JAVA_HEAP:=2G}"
              : "${AIKAR_FLAGS:=-XX:+UnlockExperimentalVMOptions -XX:+UseG1GC -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M -XX:G1ReservePercent=20 -XX:MaxGCPauseMillis=200 -XX:G1MixedGCCountTarget=4 -XX:G1MixedGCLiveThresholdPercent=90 -XX:InitiatingHeapOccupancyPercent=15 -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem -XX:MaxTenuringThreshold=1}"
              # EULA must be accepted in the data dir
              [ -f "$MC_DIR/eula.txt" ] || echo "eula=true" > "$MC_DIR/eula.txt"
              exec /usr/bin/java -Xms${JAVA_HEAP} -Xmx${JAVA_HEAP} ${AIKAR_FLAGS} -jar "$APP_DIR/server.jar" nogui
      - name: write_systemd
        action: CreateFile
        inputs:
          - path: /etc/systemd/system/minecraft.service
            permissions: '0644'
            owner: root
            group: root
            content: |
              [Unit]
              Description=Paper Minecraft Server
              After=network.target
              Wants=network-online.target

              [Service]
              EnvironmentFile=-/etc/minecraft/minecraft.env
              WorkingDirectory=/opt/minecraft
              ExecStart=/opt/mc-app/launch.sh
              Restart=always
              RestartSec=10
              SuccessExitStatus=0 1 143
              User=minecraft
              UMask=027
              NoNewPrivileges=yes
              PrivateTmp=yes
              ProtectSystem=strict
              ProtectHome=read-only
              ProtectClock=yes
              ProtectControlGroups=yes
              ProtectKernelModules=yes
              ProtectKernelTunables=yes
              RestrictSUIDSGID=yes
              RestrictNamespaces=yes
              LockPersonality=yes
              CapabilityBoundingSet=
              AmbientCapabilities=
              ReadWritePaths=/opt/minecraft /etc/minecraft
              LimitNOFILE=65535

              [Install]
              WantedBy=multi-user.target
      - name: logrotate
        action: CreateFile
        inputs:
          - path: /etc/logrotate.d/minecraft
            permissions: '0644'
            owner: root
            group: root
            content: |
              /opt/minecraft/logs/*.log {
                daily
                rotate 14
                compress
                missingok
                copytruncate
              }
